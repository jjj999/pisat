# pisat の開発環境と環境構築について

## 開発環境

現状の開発環境は以下のとおりです．
pisat を利用する場合は**必ずしも**これに従う必要はありませんが，
pisat を開発する場合には遵守しなければなりません．

### Raspberry Pi 

* Raspberry Pi 4 Model B
* Raspberry Pi Zero
* Raspberry Pi OS 32bit (released 2020-05-27)

### Python

* Python 3.7
* 依存パッケージはPipfileを参照 (変更可能性あり)

### Python パッケージに関する注意

出来るだけサードパーティ製の Python パッケージを利用しないようにしてください．
利用せずに解決できるのであれば，その方法を選びましょう．
また，Python 標準ライブラリやその他サードパーティ製のライブラリを使用する場合は，
API および必要ならばソースコードを熟読の上で利用してください．

## 環境構築

pisatの開発のためには，

* PC (Raspberry Pi ではないマシン) での開発環境の構築
* Raspberry Pi での開発環境の構築 (任意)

の2つの環境構築が必要となります．
ただし Raspberry Pi を使用せずとも開発は出来るので後者は任意です．

### 方法

1. pisat リポジトリを clone
2. pipenv で Python の仮想環境を構築
3. OpenCV のインストール

基本的にはこれで終了です．
OpenCV は現状 Pipfile に含めると，Raspberry Pi 側での環境構築時にライブラリなどの
依存関係の問題からエラーが発生します．
この問題は今後解決すべき問題ですが，解消されていないうちは Pipfile から外して置くことが良いでしょう．
また，解消されていないうちは PC と Raspberry Pi で OpenCV の
[インストール方法](https://www.pyimagesearch.com/opencv-tutorials-resources-guides/)が異なる場合があります．


Raspberry Pi 初回起動時の場合は setup.sh に記述してあるコマンドを実行して，
開発に必要なアプリケーションをインストールすると良いでしょう．
既にインストールしてある場合は必要ないです．

### 具体例

以下では上記の方法の具体例を示していきます．

まずは pisat リポジトリの clone を行います．

```$ git clone https://github.com/jjj999/pisat.git```

次に，クローンしたローカルリポジトリ内で Python 仮想環境を作ります．
以下のコマンドをpisatのローカルリポジトリ上 (Pipfileがあるディレクトリ上) で行ってください．

```$ pipenv install```

Pythonのバージョンの不一致で実行が失敗した場合は，PipfileのPythonのバージョンを自身のPythonのバージョンと
一致するように変更して再実行してみてください．
Python の複数バージョンの管理は [pienv](https://github.com/pyenv/pyenv) が便利です．

上のコマンドを実行すると，Pythonの仮想環境が生成されますが，生成が完了するとコンソール上に「pisat」から始まる
仮想環境の名前が表示されるはずですので，その名前をコピーして保管しておいてください (デバッグの設定の際に利用します)．
もしわからない場合は，~/.local/share/virtualenvs/ 内に仮想環境の名前があります．

### デバッグの設定

デバッグは通常は Raspberry Pi 上で行いますが，簡易的なものであれば PC 上でも出来るようになっています．
したがって，どちらの環境でもデバッグを素早く出来るような環境を整えておくと良さそうです．
デバッグで問題となるのは，編集中の pisat パッケージと仮想環境上で参照する pisat パッケージが
異なる，あるいはそもそも仮想環境上で pisat パッケージ が Python の参照可能なパッケージに含まれていないという点です．
すなわち，デバッグをしようとしても自分が編集した pisat パッケージで実行できない，あるいは pisat パッケージを
 import すら出来ない状態にあるということです． 

この問題を解決するために，仮想環境上の参照パッケージに強引に自身が編集した pisat パッケージを追加する
スクリプトを実行します．
そのスクリプトは clone した pisat リポジトリに含まれている local.py です．
ただし，local.py は自身の環境に合わせて編集する必要があります． 

まず，ローカルリポジトリ上の local.py を別名 _local.py でコピーします．

```$ cp local.py _local.py```

コピーファイルを作成したら，コピーファイルを編集します．
コピーファイル _local.py を開くと，編集すべき行にコメントがあるので，それに従って編集してください．
仮想環境の名前を設定する必要がありますが，上で保管しておいた``` pisat-... ```という仮想環境の名前をペーストすれば大丈夫です．
